# Multi-Channel Licensing Architecture

## ğŸ¯ Overview

AiChemist Transmutation Codex supports **multiple sales channels** with a
flexible, multi-table licensing architecture.

## ğŸ—ï¸ Database Architecture

### **Two Independent Licensing Systems:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AICHEMIST LICENSING                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   GUMROAD SYSTEM     â”‚      â”‚   LEGACY/STRIPE      â”‚   â”‚
â”‚  â”‚   (Current Active)   â”‚      â”‚   (Future/Other)     â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                      â”‚      â”‚                      â”‚   â”‚
â”‚  â”‚ gumroad_licenses     â”‚      â”‚ licenses             â”‚   â”‚
â”‚  â”‚  - UUID primary key  â”‚      â”‚  - bigint id         â”‚   â”‚
â”‚  â”‚  - license_key       â”‚      â”‚  - license_key       â”‚   â”‚
â”‚  â”‚  - gumroad_purchase  â”‚      â”‚  - type (tier)       â”‚   â”‚
â”‚  â”‚  - tier (basic/pro)  â”‚      â”‚  - status            â”‚   â”‚
â”‚  â”‚  - machine_id        â”‚      â”‚  - max_activations   â”‚   â”‚
â”‚  â”‚  - gumroad_data      â”‚      â”‚                      â”‚   â”‚
â”‚  â”‚                      â”‚      â”‚ activations          â”‚   â”‚
â”‚  â”‚ license_usage        â”‚      â”‚  - license_id (FK)   â”‚   â”‚
â”‚  â”‚  - UUID primary key  â”‚      â”‚  - machine_id        â”‚   â”‚
â”‚  â”‚  - license_key       â”‚      â”‚                      â”‚   â”‚
â”‚  â”‚  - conversion_type   â”‚      â”‚ usage_logs           â”‚   â”‚
â”‚  â”‚  - file_size_bytes   â”‚      â”‚  - license_id (FK)   â”‚   â”‚
â”‚  â”‚                      â”‚      â”‚  - converter_name    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ›’ **Sales Channels**

### **Channel 1: Gumroad** âœ… ACTIVE

- **URL**: https://aichemist.gumroad.com
- **Tables**: `gumroad_licenses`, `license_usage`
- **Product ID**: `E7oYHqtGSVBBWcpbCFyF-A==`
- **Validation**: Gumroad API `/v2/licenses/verify`
- **Features**:
  - Instant delivery via email
  - Gumroad handles payment processing
  - License keys generated by Gumroad
  - Low fees (3.5% + 30Â¢)

### **Channel 2: Stripe + Website** ğŸš§ PLANNED

- **URL**: Your own website (TBD)
- **Tables**: `licenses`, `activations`, `usage_logs`
- **Validation**: Custom RSA or Stripe API
- **Features**:
  - Full control over checkout experience
  - Custom pricing/bundles
  - Direct customer relationship
  - Integration with your website
  - Subscription options available

### **Channel 3: Other Platforms** ğŸ”® FUTURE

- **Potential**: FastSpring, Paddle, LemonSqueezy
- **Tables**: Could use `licenses` system or create new tables
- **Flexibility**: Architecture supports unlimited channels

## ğŸ”§ **Technical Implementation**

### **Unified License Manager**

The `LicenseManager` class handles both systems:

```python
from transmutation_codex.core.licensing import LicenseManager

manager = LicenseManager()

# Automatically detects license type and validates accordingly
status = manager.activate_license(license_key)

# Works with:
# - Gumroad keys (verified via Gumroad API)
# - Stripe keys (verified via Stripe API or RSA)
# - Other channel keys (custom validation)
```

### **License Key Format Detection**

Different channels use different key formats:

| Channel | Format     | Example                                | Detection                     |
| ------- | ---------- | -------------------------------------- | ----------------------------- |
| Gumroad | Hex groups | `BA71859E-F8B940F3-84CF6177-426FFEF2`  | Gumroad API verification      |
| Stripe  | Custom     | `STRIPE-XXXXX-XXXXX-XXXXX`             | Prefix or validation endpoint |
| Legacy  | UUID       | `123e4567-e89b-12d3-a456-426614174000` | Database lookup               |

### **Activation Flow**

```python
def activate_license(self, license_key: str) -> Dict[str, Any]:
    """
    Unified activation supporting multiple channels.

    1. Try Gumroad verification (if matches format)
    2. Try Stripe verification (if matches format)
    3. Try legacy database lookup
    4. Return appropriate error if all fail
    """
    # Gumroad
    if self._looks_like_gumroad_key(license_key):
        return self._activate_gumroad_license(license_key)

    # Stripe
    if self._looks_like_stripe_key(license_key):
        return self._activate_stripe_license(license_key)

    # Legacy/Database
    return self._activate_legacy_license(license_key)
```

## ğŸ“Š **Database Queries Across Channels**

### **View All Active Licenses**

```sql
-- Union query across both systems
SELECT
    'gumroad' as channel,
    license_key,
    email,
    tier as license_type,
    status,
    activation_date,
    machine_id
FROM gumroad_licenses

UNION ALL

SELECT
    'stripe/legacy' as channel,
    license_key,
    email,
    type as license_type,
    status,
    created_at as activation_date,
    NULL as machine_id  -- In activations table for legacy
FROM licenses;
```

### **Total Conversions Across All Channels**

```sql
-- Gumroad usage
SELECT
    'gumroad' as channel,
    COUNT(*) as total_conversions,
    SUM(file_size_bytes) as total_data
FROM license_usage

UNION ALL

-- Legacy usage
SELECT
    'stripe/legacy' as channel,
    COUNT(*) as total_conversions,
    SUM(input_file_size) as total_data
FROM usage_logs;
```

### **Revenue Attribution**

```sql
-- Count licenses by channel
SELECT
    channel,
    license_type,
    COUNT(*) as count
FROM (
    SELECT 'gumroad' as channel, tier as license_type FROM gumroad_licenses
    UNION ALL
    SELECT 'stripe/legacy' as channel, type as license_type FROM licenses
) AS all_licenses
GROUP BY channel, license_type;
```

## ğŸ” **Security Considerations**

### **Gumroad Channel**

- âœ… Validation: Gumroad API
- âœ… Keys generated by: Gumroad
- âœ… Stored in: `gumroad_licenses` table
- âœ… Purchase verification: Gumroad purchase_id

### **Stripe Channel**

- â³ Validation: Stripe API or custom RSA
- â³ Keys generated by: Your webhook server
- â³ Stored in: `licenses` table
- â³ Purchase verification: Stripe payment_intent_id

## ğŸš€ **Migration Path**

### **Phase 1: Gumroad Only** âœ… COMPLETE

- Setup: Complete
- Status: Production ready
- Usage: Primary sales channel

### **Phase 2: Add Stripe** ğŸš§ PLANNED

1. **Create Stripe Product**

   ```javascript
   // Stripe product setup
   const product = await stripe.products.create({
     name: 'AiChemist Transmutation Codex - Basic',
     metadata: {
       license_type: 'basic',
       max_activations: '1',
     },
   });
   ```

2. **Update License Manager**

   ```python
   # Add Stripe verification
   def _activate_stripe_license(self, license_key: str):
       # Verify with Stripe API
       # Store in licenses table
       # Return unified status
   ```

3. **Create Webhook Handler**

   ```python
   # Stripe webhook for license delivery
   @app.route('/webhooks/stripe', methods=['POST'])
   def stripe_webhook():
       event = stripe.Webhook.construct_event(
           payload, sig_header, webhook_secret
       )

       if event['type'] == 'payment_intent.succeeded':
           # Generate license
           # Store in licenses table
           # Email to customer
   ```

### **Phase 3: Unified Dashboard** ğŸ”® FUTURE

- View all licenses across channels
- Unified analytics
- Channel performance comparison

## ğŸ“ˆ **Analytics Across Channels**

### **Track Channel Performance**

```sql
-- Revenue by channel (requires pricing data)
WITH channel_counts AS (
    SELECT 'gumroad' as channel, tier, COUNT(*) as count
    FROM gumroad_licenses
    GROUP BY tier
    UNION ALL
    SELECT 'stripe' as channel, type as tier, COUNT(*) as count
    FROM licenses
    GROUP BY type
)
SELECT
    channel,
    tier,
    count,
    CASE tier
        WHEN 'basic' THEN count * 29
        WHEN 'pro' THEN count * 79
        WHEN 'enterprise' THEN count * 299
    END as estimated_revenue
FROM channel_counts
ORDER BY channel, tier;
```

## ğŸ¯ **Best Practices**

### **DO:**

âœ… Keep systems independent (as they are now) âœ… Use `license_key` as universal
identifier âœ… Store channel metadata in each system âœ… Validate against
appropriate API per channel âœ… Track metrics separately per channel

### **DON'T:**

âŒ Share primary keys between systems âŒ Create foreign keys between channels âŒ
Mix validation methods âŒ Assume key formats across channels

## ğŸ”„ **Future Channel Integration**

When adding new channels:

1. **Decide**: Use existing `licenses` table or create new table?
2. **Implement**: Channel-specific validation
3. **Update**: `LicenseManager` to detect and handle new format
4. **Test**: Activation flow end-to-end
5. **Document**: Key format and validation method

## ğŸ“ **Configuration Files**

### **Gumroad Config**

```yaml
# scripts/licensing/gumroad/gumroad_config.yaml
products:
  basic:
    permalink: 'transmutation-codex-basic'
    product_id: 'E7oYHqtGSVBBWcpbCFyF-A=='
```

### **Stripe Config** (Future)

```yaml
# scripts/licensing/stripe/stripe_config.yaml
products:
  basic:
    price_id: 'price_xxx'
    product_id: 'prod_xxx'
    license_type: 'basic'
```

## ğŸŠ **Summary**

Your multi-channel architecture provides:

- âœ… **Flexibility**: Sell on multiple platforms
- âœ… **Scalability**: Easy to add new channels
- âœ… **Independence**: Channels don't interfere with each other
- âœ… **Reliability**: One channel down doesn't affect others
- âœ… **Analytics**: Compare performance across channels

**This is a professional, production-ready architecture!** ğŸš€

---

**Architecture Version:** 1.0 **Active Channels:** Gumroad (1/3) **Planned
Channels:** Stripe, Others **Last Updated:** November 13, 2025
