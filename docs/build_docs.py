#!/usr/bin/env python3
"""Build script for Aichemist Transmutation Codex Sphinx documentation.

This script automates the full documentation build process by:
1. Calling `generate_api_docs()` (from this script, or could be an imported module)
   to run `sphinx-apidoc`. This scans the source code and generates .rst files
   for the API documentation.
2. Calling `build_html_docs()` (from this script) to run `sphinx-build`.
   This takes all the .rst files (both manually written ones and the API docs)
   and builds the final HTML documentation.

Before running, ensure Sphinx and any necessary extensions (like sphinx-rtd-theme)
are installed in your Python environment.
"""

import subprocess
import sys
from pathlib import Path

# --- Configuration Section ---
# Path to the directory containing this script (docs/)
DOCS_DIR = Path(__file__).parent.absolute()
# Path to the Sphinx source directory (docs/source/)
# This is where conf.py, index.rst, and other .rst files are located.
SOURCE_DIR = DOCS_DIR / "source"
# Path to the output directory for the built documentation (docs/build/)
BUILD_DIR = DOCS_DIR / "build"
# Path to the subdirectory within docs/source/ where API .rst files are generated (docs/source/api/)
API_DIR = SOURCE_DIR / "api"
# Path to the actual Python source code of your project (src/aichemist_transmutation_codex/)
SRC_DIR = DOCS_DIR.parent / "src" / "aichemist_transmutation_codex"
# --- End Configuration Section ---


def generate_api_docs():
    """Generate API documentation using sphinx-apidoc.
    This function calls sphinx-apidoc to scan the Python source code (`SRC_DIR`)
    and generate .rst files in `API_DIR`.
    """
    print("Step 1: Generating API documentation (sphinx-apidoc)...")

    # Ensure the API output directory exists; clean it if it does.
    if not API_DIR.exists():
        print(f"  Creating API output directory: {API_DIR}")
        API_DIR.mkdir(parents=True)
    else:
        print(f"  Cleaning existing API documentation files from: {API_DIR}")
        for file in API_DIR.glob("*.rst"):
            file.unlink()  # Remove old .rst files

    # sphinx-apidoc command arguments
    # See: https://www.sphinx-doc.org/en/master/man/sphinx-apidoc.html
    apidoc_cmd = [
        "sphinx-apidoc",
        "-f",  # Force: Overwrite existing files without asking
        "-e",  # Separate: Put each module on its own page
        "-M",  # Module First: Put module doc before submodule docs
        "-o",
        str(API_DIR),  # Output directory
        str(SRC_DIR),  # Directory of Python source code to scan
        # Add exclusion paths here if needed, e.g.:
        # str(SRC_DIR / 'tests') # To exclude a 'tests' subdirectory
    ]

    print(f"  Running command: {' '.join(apidoc_cmd)}")
    try:
        # Execute sphinx-apidoc
        subprocess.run(apidoc_cmd, check=True, capture_output=True, text=True)
        print("  API documentation generation successful!")
    except subprocess.CalledProcessError as e:
        print("  Error generating API documentation with sphinx-apidoc:")
        print(f"    Return code: {e.returncode}")
        print(f"    Stdout:\n{e.stdout}")
        print(f"    Stderr:\n{e.stderr}")
        return False  # Indicate failure
    except FileNotFoundError:
        print(
            "  Error: sphinx-apidoc command not found. Is Sphinx installed and in PATH?"
        )
        return False

    return True  # Indicate success


def build_html_docs():
    """Build HTML documentation using sphinx-build.
    This function calls sphinx-build to take all .rst files in `SOURCE_DIR`
    (including those generated by sphinx-apidoc) and build HTML output
    in `BUILD_DIR / 'html'`.
    """
    print("\nStep 2: Building HTML documentation (sphinx-build)...")

    # Ensure the main build directory exists.
    if not BUILD_DIR.exists():
        print(f"  Creating build directory: {BUILD_DIR}")
        BUILD_DIR.mkdir(parents=True)

    # sphinx-build command arguments
    # See: https://www.sphinx-doc.org/en/master/man/sphinx-build.html
    build_cmd = [
        "sphinx-build",
        "-b",
        "html",  # Builder name: html
        "-d",
        str(
            BUILD_DIR / "doctrees"
        ),  # Path for cached doctrees (improves rebuild speed)
        str(SOURCE_DIR),  # Path to the source directory (contains conf.py, .rst files)
        str(BUILD_DIR / "html"),  # Path to the output directory for HTML files
        # Add options like -W (turn warnings into errors) or -a (rebuild all files) if needed
        # "-W",
        # "-a",
    ]

    print(f"  Running command: {' '.join(build_cmd)}")
    try:
        # Execute sphinx-build
        subprocess.run(build_cmd, check=True, capture_output=True, text=True)
        print("  HTML documentation build successful!")
    except subprocess.CalledProcessError as e:
        print("  Error building HTML documentation with sphinx-build:")
        print(f"    Return code: {e.returncode}")
        print(f"    Stdout:\n{e.stdout}")
        print(f"    Stderr:\n{e.stderr}")
        return False  # Indicate failure
    except FileNotFoundError:
        print(
            "  Error: sphinx-build command not found. Is Sphinx installed and in PATH?"
        )
        return False

    return True  # Indicate success


def main():
    """Main function to orchestrate the entire documentation build process."""
    print("Starting Aichemist Transmutation Codex documentation build process...")

    # Initial check: Verify sphinx-build is available before starting.
    # This provides a clearer error message early if Sphinx isn't installed.
    try:
        # Run `sphinx-build --version` as a quick check.
        # `capture_output=True` hides the version output unless there's an error.
        subprocess.run(["sphinx-build", "--version"], check=True, capture_output=True)
    except (subprocess.CalledProcessError, FileNotFoundError):
        print(
            "Error: sphinx-build command not found or Sphinx is not properly installed."
        )
        print(
            "Please ensure Sphinx is installed in your Python environment and added to your PATH."
        )
        print(
            "  You can typically install it with: pip install sphinx sphinx-rtd-theme sphinx-autodoc-typehints sphinx-copybutton"
        )
        return 1  # Exit with an error code

    # --- Step 1: Generate API documentation (.rst files from source code) ---
    if not generate_api_docs():
        print("\nDocumentation build failed during API generation.")
        return 1  # Exit with an error code

    # --- Step 2: Build HTML documentation (from all .rst files) ---
    if not build_html_docs():
        print("\nDocumentation build failed during HTML generation.")
        return 1  # Exit with an error code

    # --- Build Complete ---
    html_index_path = BUILD_DIR / "html" / "index.html"
    print("\nDocumentation build complete!")
    print(f"The HTML documentation is available at: {html_index_path.resolve()}")
    # Provide a clickable file URI for easy access in many terminals.
    print(f"You can try opening it in your browser: file://{html_index_path.resolve()}")

    return 0  # Exit successfully


if __name__ == "__main__":
    # sys.exit() ensures that the script's exit code is propagated.
    sys.exit(main())
