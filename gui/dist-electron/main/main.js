"use strict";const b=require("child_process"),n=require("electron"),w=require("node:fs"),a=require("node:path");process.platform==="win32"&&n.app.setAppUserModelId("com.aichemist.transmutationcodex");require("electron-squirrel-startup")&&n.app.quit();const x=n.app.requestSingleInstanceLock();x?n.app.on("second-instance",()=>{i&&(i.isMinimized()&&i.restore(),i.focus())}):(console.log("Another instance is already running. Exiting..."),n.app.quit());let i;function D(){if(process.env.NODE_ENV==="development"||!n.app.isPackaged){const e=a.resolve(__dirname,"../../.."),l=process.platform==="win32"?[a.join(e,"gui/assets/icon.ico"),a.join(e,"assets/icon.ico"),a.join(e,"gui/assets/icon.png"),a.join(e,"assets/icon.png"),a.join(e,"public/assets/icon.png")]:[a.join(e,"gui/assets/icon.png"),a.join(e,"assets/icon.png"),a.join(e,"public/assets/icon.png"),a.join(e,"gui/assets/icon.ico"),a.join(e,"assets/icon.ico")];for(const c of l)if(w.existsSync(c))return console.log(`Using icon: ${c}`),c;console.warn("No icon file found in development mode. Using default.");return}else{const e=a.join(process.resourcesPath,"assets/icon.ico");if(w.existsSync(e))return e;const l=a.join(process.resourcesPath,"assets/icon.png");return w.existsSync(l)?l:void 0}}function T(){const s=D();i=new n.BrowserWindow({width:1024,height:768,icon:s,webPreferences:{preload:a.join(__dirname,"../preload/preload.js"),nodeIntegration:!1,contextIsolation:!0}}),process.env.NODE_ENV==="development"?(i.loadURL("http://localhost:3000"),i.webContents.openDevTools()):i.loadFile(a.join(__dirname,"../../dist/index.html")),i.on("closed",()=>{i=null})}n.app.whenReady().then(()=>{n.app.isPackaged&&(n.protocol.registerFileProtocol("app",(e,l)=>{const c=e.url.substr(6),d=a.normalize(a.join(__dirname,"../../dist",c));console.log(`[Protocol] Serving: app://${c} -> ${d}`),w.existsSync(d)?l({path:d}):(console.error(`[Protocol] File not found: ${d}`),l({error:-6}))}),console.log("[Protocol] Registered app:// protocol for production"));const s=D();s&&process.platform==="darwin"&&n.app.dock&&n.app.dock.setIcon(s),T(),n.app.on("activate",()=>{n.BrowserWindow.getAllWindows().length===0&&T()})});n.app.on("window-all-closed",()=>{process.platform!=="darwin"&&n.app.quit()});n.ipcMain.handle("dialog:openFile",async(s,e)=>{if(!i)return[];const l={properties:["openFile","multiSelections"]};e&&e.filters&&(l.filters=e.filters);const{canceled:c,filePaths:d}=await n.dialog.showOpenDialog(i,l);return c?[]:d});n.ipcMain.handle("dialog:openDirectory",async()=>{if(!i)return null;const{canceled:s,filePaths:e}=await n.dialog.showOpenDialog(i,{properties:["openDirectory"]});return s?null:e[0]});n.ipcMain.handle("run-conversion",async(s,{conversionType:e,inputFiles:l,outputDir:c,options:d})=>new Promise((m,P)=>{const f=a.resolve(n.app.getAppPath(),"../src/transmutation_codex/adapters/bridges/electron_bridge.py"),N=a.resolve(n.app.getAppPath(),"../.venv/Scripts/python.exe"),S=a.resolve(n.app.getAppPath(),"../.venv/bin/python");let u="python";try{const r=process.platform==="win32"?N:S;w.accessSync(r),u=r,console.log("Using venv Python:",u)}catch{console.log("Venv Python not found or accessible, using system Python.")}let y=[f,e,"--input-files",...l];c&&y.push("--output-dir",c),d&&Object.entries(d).forEach(([r,o])=>{if(o!=null&&typeof o!="object"){const p=`--${r.replace(/[A-Z]/g,h=>`-${h.toLowerCase()}`)}`;typeof o=="boolean"?o===!0&&y.push(p):y.push(p,String(o))}}),console.log("Spawning Python script:",u,"with args:",y.join(" "));const g=b.spawn(u,y);let v="";g.stdout.on("data",r=>{var p,h;v+=r.toString(),console.log(`Python stdout chunk: ${r.toString()}`);let o=v.indexOf(`
`);for(;o!==-1;){const E=v.substring(0,o).trim();if(v=v.substring(o+1),E&&i)if(E.startsWith("PROGRESS:")||E.startsWith("BATCH_PROGRESS:")||E.startsWith("RESULT:")||E.startsWith("ERROR:")||E.startsWith("SINGLE_RESULT:")||E.startsWith("BATCH_RESULT:"))try{const A=E.substring(E.indexOf(":")+1),_=JSON.parse(A),R=_.error_code||_.errorCode||((p=_.data)==null?void 0:p.error_code)||((h=_.data)==null?void 0:h.errorCode);R&&console.log(`[${R}] ${_.message||JSON.stringify(_.data)}`),i.webContents.send("conversion-event",_)}catch(A){const _="FRONTEND_JSON_PARSE_FAILED";console.error(`[${_}] Failed to parse JSON from Python:`,E,A),i.webContents.send("conversion-event",{type:"raw_error",data:E,error:A.message,error_code:_})}else console.log("Non-JSON Python stdout:",E);o=v.indexOf(`
`)}});let t="";g.stderr.on("data",r=>{t+=r.toString(),console.error(`Python stderr chunk: ${r.toString()}`);let o=t.indexOf(`
`);for(;o!==-1;){const p=t.substring(0,o).trim();t=t.substring(o+1),p&&i&&i.webContents.send("conversion-event",{type:"stderr",data:p}),o=t.indexOf(`
`)}}),g.on("close",r=>{if(console.log(`Python script exited with code ${r}`),t.trim()&&i&&i.webContents.send("conversion-event",{type:"stderr",data:t.trim()}),r===0)console.log("[SUCCESS] Python script finished successfully"),m({success:!0,message:"Python script finished successfully."});else{const o="FRONTEND_PYTHON_PROCESS_FAILED";console.error(`[${o}] Python script exited with code ${r}. Check logs for details.`),P({success:!1,message:`Python script exited with code ${r}. Check logs for details.`,error_code:o,exitCode:r})}}),g.on("error",r=>{const o="FRONTEND_PYTHON_PROCESS_FAILED";console.error(`[${o}] Failed to start Python process:`,r),P({success:!1,message:`Failed to start Python process: ${r.message}`,error_code:o,error:r.message})})}));n.ipcMain.handle("convert-mdx-to-md",async(s,{inputFile:e,outputFile:l})=>(console.log(`MDX to MD conversion requested for: ${e}`),{success:!1,error:"MDX to MD conversion is not yet implemented. React cannot run in Electron main process. This converter needs to be reimplemented as a spawned process or moved to Python backend."}));n.ipcMain.on("log:gui-cleared",()=>{console.log("======== GUI Log Cleared by User ========")});async function O(s,e=[]){return new Promise((l,c)=>{var g,v;const d=!process.defaultApp&&!((g=process.env.NODE_ENV)!=null&&g.includes("dev")),m=n.app.getAppPath();console.log("=".repeat(80)),console.log("LICENSE COMMAND EXECUTION START"),console.log("=".repeat(80)),console.log("Command:",s),console.log("Args count:",e.length),console.log("First 50 chars of first arg:",((v=e[0])==null?void 0:v.substring(0,50))+"..."),console.log("Is Production:",d),console.log("App Path:",m),console.log("Platform:",process.platform),console.log("Node ENV:",process.env.NODE_ENV),console.log("Default App:",process.defaultApp);let P,f;if(d){const t=a.join(process.resourcesPath,"python-backend","transmutation_codex","adapters","bridges","license_bridge.py");if(console.log("✓ Production mode detected"),console.log("  License bridge script:",t),console.log("  Resources path:",process.resourcesPath),!w.existsSync(t)){const h="FRONTEND_PYTHON_PROCESS_FAILED";console.error(`[${h}] License bridge script not found`),c({error:`Python backend not found at: ${t}`,details:"The bundled Python source code is missing from the installation",error_code:h});return}console.log("  ✓ Script exists"),P="python";const r=["python","python3","C:\\Python313\\python.exe","C:\\Python312\\python.exe","C:\\Python311\\python.exe","C:\\Program Files\\Python313\\python.exe","C:\\Program Files\\Python312\\python.exe"];let o=!1;for(const h of r)try{require("child_process").execSync(`"${h}" --version`,{stdio:"ignore"}),P=h,o=!0,console.log(`  ✓ Found Python at: ${h}`);break}catch{}if(!o){const h="FRONTEND_PYTHON_PROCESS_FAILED";console.error(`[${h}] Python not found in system PATH or common locations`),c({error:"Python 3.13+ is required but not found. Please install Python from python.org",details:"Searched PATH and common installation locations",error_code:h});return}const p=a.join(process.resourcesPath,"python-backend");process.env.PYTHONPATH=p,console.log("  Set PYTHONPATH:",p),f=[t,s,...e]}else{const t=a.resolve(m,"../src/transmutation_codex/adapters/bridges/license_bridge.py");console.log("✓ Development mode detected"),console.log("  Script path:",t);const r=a.resolve(m,"../.venv/Scripts/python.exe"),o=a.resolve(m,"../.venv/bin/python");P="python";try{const p=process.platform==="win32"?r:o;w.accessSync(p),P=p,console.log("  ✓ Using venv Python:",P)}catch{console.log("  ⚠ Venv not found, using system Python")}try{w.accessSync(t),console.log("  ✓ Script exists and is accessible")}catch(p){const h="FRONTEND_PYTHON_PROCESS_FAILED";console.error(`[${h}] Script not found:`,p),c({error:`License bridge script not found at: ${t}`,details:p.message,error_code:h});return}f=[t,s,...e]}console.log("Final command to execute:"),console.log("  Executable:",P),console.log("  Arguments:",f.map((t,r)=>r===f.length-1&&t.length>100?`${t.substring(0,50)}...${t.substring(t.length-20)}`:t).join(" ")),console.log("-".repeat(80)),console.log("Spawning Python process...");const N={...process.env,...process.env.SUPABASE_URL&&{SUPABASE_URL:process.env.SUPABASE_URL},...process.env.SUPABASE_ANON_KEY&&{SUPABASE_ANON_KEY:process.env.SUPABASE_ANON_KEY},...process.env.SUPABASE_SERVICE_KEY&&{SUPABASE_SERVICE_KEY:process.env.SUPABASE_SERVICE_KEY},PYTHONUNBUFFERED:"1"};console.log("Environment variables:"),console.log("  SUPABASE_URL:",process.env.SUPABASE_URL?"***set***":"not set"),console.log("  SUPABASE_ANON_KEY:",process.env.SUPABASE_ANON_KEY?"***set***":"not set");let S;try{S=b.spawn(P,f,{env:N}),console.log("✓ Process spawned successfully, PID:",S.pid)}catch(t){const r="FRONTEND_PYTHON_PROCESS_FAILED";console.error(`[${r}] Failed to spawn process:`,t),c({error:`Failed to spawn Python process: ${t.message}`,executable:P,args:f,error_code:r});return}let u="",y="";S.stdout.on("data",t=>{const r=t.toString();u+=r,console.log("[PYTHON STDOUT]:",r),i&&i.webContents.send("license-debug",{type:"stdout",data:r})}),S.stderr.on("data",t=>{const r=t.toString();y+=r,console.error("[PYTHON STDERR]:",r),i&&i.webContents.send("license-debug",{type:"stderr",data:r})}),S.on("close",t=>{const r={exitCode:t,stdoutLength:u.length,stderrLength:y.length,stdout:u,stderr:y};console.log("-".repeat(80)),console.log("Process exited with code:",t),console.log("STDOUT length:",u.length),console.log("STDERR length:",y.length),u&&console.log("Full STDOUT:",u),y&&console.error("Full STDERR:",y),console.log("=".repeat(80)),console.log("LICENSE COMMAND EXECUTION END"),console.log("=".repeat(80)),i&&i.webContents.send("license-debug",{type:"summary",data:r});let o=null;if(u.trim())try{o=JSON.parse(u),console.log("✓ Successfully parsed JSON result:",o)}catch(p){console.warn("Could not parse stdout as JSON:",p)}if(t===0)if(o)l(o);else{const p="FRONTEND_JSON_PARSE_FAILED";console.error(`[${p}] No valid JSON output`),console.error("Raw stdout:",u),c({error:"Failed to parse license command output",stdout:u,stderr:y,error_code:p})}else{const p="FRONTEND_LICENSE_ACTIVATION_FAILED";console.error(`[${p}] Command failed with non-zero exit code ${t}`);let h=`License command failed with code ${t}`;(o!=null&&o.error||(o==null?void 0:o.success)===!1&&(o!=null&&o.error))&&(h=o.error),c({error:h,exitCode:t,stderr:y,stdout:u,parsedResult:o,error_code:p})}}),S.on("error",t=>{const r="FRONTEND_PYTHON_PROCESS_FAILED";console.error(`[${r}] Process error event:`,t),c({error:`Failed to run license command: ${t.message}`,errorName:t.name,errorStack:t.stack,error_code:r})})})}n.ipcMain.handle("license:get-status",async()=>{try{return await O("get-status")}catch(s){return console.error("Error getting license status:",s),{license_type:"trial",error:s.error||"Unknown error"}}});n.ipcMain.handle("license:activate",async(s,e)=>{console.log("=".repeat(80)),console.log("LICENSE ACTIVATION REQUESTED"),console.log("=".repeat(80)),console.log("License key length:",(e==null?void 0:e.length)||0),console.log("License key preview:",(e==null?void 0:e.substring(0,50))||"none"),i&&i.webContents.send("license-debug",{type:"info",data:{message:"Starting license activation...",licenseKeyLength:(e==null?void 0:e.length)||0}});try{return await O("activate",[e])}catch(l){console.error("Error activating license:",l);let c=l.error||"License activation failed";if(l.stdout)try{const d=JSON.parse(l.stdout);(d.error||d.success===!1&&d.error)&&(c=d.error)}catch{}if(l.stderr){const d=l.stderr.split(`
`);for(const m of d)if(m.includes("ERROR:")||m.includes("✗")){const P=m.match(/✗\s+(?:Activation failed|Error):\s*(.+)/i);if(P){c=P[1].trim();break}const f=m.match(/ERROR:\s*(.+)/i);if(f){c=f[1].trim();break}}}throw new Error(c)}});n.ipcMain.handle("license:deactivate",async()=>{try{return await O("deactivate")}catch(s){throw console.error("Error deactivating license:",s),new Error(s.error||"License deactivation failed")}});n.ipcMain.handle("license:get-trial-status",async()=>{try{return await O("get-trial-status")}catch(s){return console.error("Error getting trial status:",s),{status:"error",error:s.error||"Unknown error"}}});async function C(s,e=[]){return new Promise((l,c)=>{const d=a.resolve(n.app.getAppPath(),"../src/transmutation_codex/adapters/bridges/telemetry_bridge.py"),m=a.resolve(n.app.getAppPath(),"../.venv/Scripts/python.exe"),P=a.resolve(n.app.getAppPath(),"../.venv/bin/python");let f="python";try{const g=process.platform==="win32"?m:P;w.accessSync(g),f=g}catch{console.log("Using system Python for telemetry command")}const N=[d,s,...e.map(g=>JSON.stringify(g))];console.log("Running telemetry command:",s);const S=b.spawn(f,N);let u="",y="";S.stdout.on("data",g=>{u+=g.toString()}),S.stderr.on("data",g=>{y+=g.toString()}),S.on("close",g=>{if(g===0)try{const v=JSON.parse(u);l(v)}catch{l({success:!0})}else c({error:`Telemetry command failed with code ${g}`,stderr:y})}),S.on("error",g=>{c({error:`Failed to run telemetry command: ${g.message}`})})})}n.ipcMain.handle("telemetry:get-consent-status",async()=>{try{return await C("get-consent-status")}catch(s){return console.error("Error getting telemetry consent status:",s),{has_consent:!1,can_request:!0,error:s.error||"Unknown error"}}});n.ipcMain.handle("telemetry:grant-consent",async()=>{try{return await C("grant-consent")}catch(s){throw console.error("Error granting telemetry consent:",s),new Error(s.error||"Failed to grant consent")}});n.ipcMain.handle("telemetry:revoke-consent",async()=>{try{return await C("revoke-consent")}catch(s){throw console.error("Error revoking telemetry consent:",s),new Error(s.error||"Failed to revoke consent")}});n.ipcMain.handle("open-external",async(s,e)=>{const{shell:l}=require("electron");try{return await l.openExternal(e),{success:!0}}catch(c){return console.error("Error opening external URL:",c),{success:!1,error:c.message}}});
