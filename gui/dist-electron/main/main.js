"use strict";const b=require("child_process"),s=require("electron"),_=require("node:fs"),i=require("node:path");process.platform==="win32"&&s.app.setAppUserModelId("com.aichemist.transmutationcodex");require("electron-squirrel-startup")&&s.app.quit();const D=s.app.requestSingleInstanceLock();D?s.app.on("second-instance",()=>{a&&(a.isMinimized()&&a.restore(),a.focus())}):(console.log("Another instance is already running. Exiting..."),s.app.quit());let a;function U(){if(process.env.NODE_ENV==="development"||!s.app.isPackaged){const e=i.resolve(__dirname,"../../.."),l=process.platform==="win32"?[i.join(e,"gui/assets/icon.ico"),i.join(e,"assets/icon.ico"),i.join(e,"gui/assets/icon.png"),i.join(e,"assets/icon.png"),i.join(e,"public/assets/icon.png")]:[i.join(e,"gui/assets/icon.png"),i.join(e,"assets/icon.png"),i.join(e,"public/assets/icon.png"),i.join(e,"gui/assets/icon.ico"),i.join(e,"assets/icon.ico")];for(const c of l)if(_.existsSync(c))return console.log(`Using icon: ${c}`),c;console.warn("No icon file found in development mode. Using default.");return}else{const e=i.join(process.resourcesPath,"assets/icon.ico");if(_.existsSync(e))return e;const l=i.join(process.resourcesPath,"assets/icon.png");return _.existsSync(l)?l:void 0}}function x(){const r=U();a=new s.BrowserWindow({width:1024,height:768,icon:r,webPreferences:{preload:i.join(__dirname,"../preload/preload.js"),nodeIntegration:!1,contextIsolation:!0}}),process.env.NODE_ENV==="development"?(a.loadURL("http://localhost:3000"),a.webContents.openDevTools()):a.loadFile(i.join(__dirname,"../../dist/index.html")),a.on("closed",()=>{a=null})}s.app.whenReady().then(()=>{s.app.isPackaged&&(s.protocol.registerFileProtocol("app",(e,l)=>{const c=e.url.substr(6),p=i.normalize(i.join(__dirname,"../../dist",c));console.log(`[Protocol] Serving: app://${c} -> ${p}`),_.existsSync(p)?l({path:p}):(console.error(`[Protocol] File not found: ${p}`),l({error:-6}))}),console.log("[Protocol] Registered app:// protocol for production"));const r=U();r&&process.platform==="darwin"&&s.app.dock&&s.app.dock.setIcon(r),x(),s.app.on("activate",()=>{s.BrowserWindow.getAllWindows().length===0&&x()})});s.app.on("window-all-closed",()=>{process.platform!=="darwin"&&s.app.quit()});s.ipcMain.handle("dialog:openFile",async(r,e)=>{if(!a)return[];const l={properties:["openFile","multiSelections"]};e&&e.filters&&(l.filters=e.filters);const{canceled:c,filePaths:p}=await s.dialog.showOpenDialog(a,l);return c?[]:p});s.ipcMain.handle("dialog:openDirectory",async()=>{if(!a)return null;const{canceled:r,filePaths:e}=await s.dialog.showOpenDialog(a,{properties:["openDirectory"]});return r?null:e[0]});s.ipcMain.handle("run-conversion",async(r,{conversionType:e,inputFiles:l,outputDir:c,options:p})=>new Promise((E,u)=>{const y=i.resolve(s.app.getAppPath(),"../src/transmutation_codex/adapters/bridges/electron_bridge.py"),N=i.resolve(s.app.getAppPath(),"../.venv/Scripts/python.exe"),P=i.resolve(s.app.getAppPath(),"../.venv/bin/python");let h="python";try{const o=process.platform==="win32"?N:P;_.accessSync(o),h=o,console.log("Using venv Python:",h)}catch{console.log("Venv Python not found or accessible, using system Python.")}let f=[y,e,"--input-files",...l];c&&f.push("--output-dir",c),p&&Object.entries(p).forEach(([o,t])=>{if(t!=null&&typeof t!="object"){const d=`--${o.replace(/[A-Z]/g,v=>`-${v.toLowerCase()}`)}`;typeof t=="boolean"?t===!0&&f.push(d):f.push(d,String(t))}}),console.log("Spawning Python script:",h,"with args:",f.join(" "));const g=b.spawn(h,f);let m="";g.stdout.on("data",o=>{var d,v;m+=o.toString(),console.log(`Python stdout chunk: ${o.toString()}`);let t=m.indexOf(`
`);for(;t!==-1;){const S=m.substring(0,t).trim();if(m=m.substring(t+1),S&&a)if(S.startsWith("PROGRESS:")||S.startsWith("BATCH_PROGRESS:")||S.startsWith("RESULT:")||S.startsWith("ERROR:")||S.startsWith("SINGLE_RESULT:")||S.startsWith("BATCH_RESULT:"))try{const A=S.substring(S.indexOf(":")+1),w=JSON.parse(A),R=w.error_code||w.errorCode||((d=w.data)==null?void 0:d.error_code)||((v=w.data)==null?void 0:v.errorCode);R&&console.log(`[${R}] ${w.message||JSON.stringify(w.data)}`),a.webContents.send("conversion-event",w)}catch(A){const w="FRONTEND_JSON_PARSE_FAILED";console.error(`[${w}] Failed to parse JSON from Python:`,S,A),a.webContents.send("conversion-event",{type:"raw_error",data:S,error:A.message,error_code:w})}else console.log("Non-JSON Python stdout:",S);t=m.indexOf(`
`)}});let n="";g.stderr.on("data",o=>{n+=o.toString(),console.error(`Python stderr chunk: ${o.toString()}`);let t=n.indexOf(`
`);for(;t!==-1;){const d=n.substring(0,t).trim();n=n.substring(t+1),d&&a&&a.webContents.send("conversion-event",{type:"stderr",data:d}),t=n.indexOf(`
`)}}),g.on("close",o=>{if(console.log(`Python script exited with code ${o}`),n.trim()&&a&&a.webContents.send("conversion-event",{type:"stderr",data:n.trim()}),o===0)console.log("[SUCCESS] Python script finished successfully"),E({success:!0,message:"Python script finished successfully."});else{const t="FRONTEND_PYTHON_PROCESS_FAILED";console.error(`[${t}] Python script exited with code ${o}. Check logs for details.`),u({success:!1,message:`Python script exited with code ${o}. Check logs for details.`,error_code:t,exitCode:o})}}),g.on("error",o=>{const t="FRONTEND_PYTHON_PROCESS_FAILED";console.error(`[${t}] Failed to start Python process:`,o),u({success:!1,message:`Failed to start Python process: ${o.message}`,error_code:t,error:o.message})})}));s.ipcMain.handle("convert-mdx-to-md",async(r,{inputFile:e,outputFile:l})=>(console.log(`MDX to MD conversion requested for: ${e}`),{success:!1,error:"MDX to MD conversion is not yet implemented. React cannot run in Electron main process. This converter needs to be reimplemented as a spawned process or moved to Python backend."}));s.ipcMain.on("log:gui-cleared",()=>{console.log("======== GUI Log Cleared by User ========")});async function O(r,e=[]){return new Promise((l,c)=>{var g,m;const p=!process.defaultApp&&!((g=process.env.NODE_ENV)!=null&&g.includes("dev")),E=s.app.getAppPath();console.log("=".repeat(80)),console.log("LICENSE COMMAND EXECUTION START"),console.log("=".repeat(80)),console.log("Command:",r),console.log("Args count:",e.length),console.log("First 50 chars of first arg:",((m=e[0])==null?void 0:m.substring(0,50))+"..."),console.log("Is Production:",p),console.log("App Path:",E),console.log("Platform:",process.platform),console.log("Node ENV:",process.env.NODE_ENV),console.log("Default App:",process.defaultApp);let u,y;if(p){const n=i.join(E,"..","python-backend","aichemist_transmutation_codex.exe"),o=i.join(i.dirname(n),"transmutation_codex","adapters","bridges","license_bridge.py");_.existsSync(o)?(u=n,y=[o,r,...e],console.log("  Using direct script execution")):(u=n,y=["-m","transmutation_codex.adapters.bridges.license_bridge",r,...e],console.log("  Using -m flag (script not found in bundle)")),console.log("✓ Production mode detected"),console.log("  Python executable:",u),console.log("  Checking if executable exists...");try{_.accessSync(u,_.constants.X_OK),console.log("  ✓ Executable exists and is accessible")}catch(t){const d="FRONTEND_PYTHON_PROCESS_FAILED";console.error(`[${d}] Executable not found or not accessible:`,t),c({error:`Python backend not found at: ${u}`,details:t.message,error_code:d});return}}else{const n=i.resolve(E,"../src/transmutation_codex/adapters/bridges/license_bridge.py");console.log("✓ Development mode detected"),console.log("  Script path:",n);const o=i.resolve(E,"../.venv/Scripts/python.exe"),t=i.resolve(E,"../.venv/bin/python");u="python";try{const d=process.platform==="win32"?o:t;_.accessSync(d),u=d,console.log("  ✓ Using venv Python:",u)}catch{console.log("  ⚠ Venv not found, using system Python")}try{_.accessSync(n),console.log("  ✓ Script exists and is accessible")}catch(d){const v="FRONTEND_PYTHON_PROCESS_FAILED";console.error(`[${v}] Script not found:`,d),c({error:`License bridge script not found at: ${n}`,details:d.message,error_code:v});return}y=[n,r,...e]}console.log("Final command to execute:"),console.log("  Executable:",u),console.log("  Arguments:",y.map((n,o)=>o===y.length-1&&n.length>100?`${n.substring(0,50)}...${n.substring(n.length-20)}`:n).join(" ")),console.log("-".repeat(80)),console.log("Spawning Python process...");const N={...process.env,...process.env.SUPABASE_URL&&{SUPABASE_URL:process.env.SUPABASE_URL},...process.env.SUPABASE_ANON_KEY&&{SUPABASE_ANON_KEY:process.env.SUPABASE_ANON_KEY},...process.env.SUPABASE_SERVICE_KEY&&{SUPABASE_SERVICE_KEY:process.env.SUPABASE_SERVICE_KEY},PYTHONUNBUFFERED:"1"};console.log("Environment variables:"),console.log("  SUPABASE_URL:",process.env.SUPABASE_URL?"***set***":"not set"),console.log("  SUPABASE_ANON_KEY:",process.env.SUPABASE_ANON_KEY?"***set***":"not set");let P;try{P=b.spawn(u,y,{env:N}),console.log("✓ Process spawned successfully, PID:",P.pid)}catch(n){const o="FRONTEND_PYTHON_PROCESS_FAILED";console.error(`[${o}] Failed to spawn process:`,n),c({error:`Failed to spawn Python process: ${n.message}`,executable:u,args:y,error_code:o});return}let h="",f="";P.stdout.on("data",n=>{const o=n.toString();h+=o,console.log("[PYTHON STDOUT]:",o),a&&a.webContents.send("license-debug",{type:"stdout",data:o})}),P.stderr.on("data",n=>{const o=n.toString();f+=o,console.error("[PYTHON STDERR]:",o),a&&a.webContents.send("license-debug",{type:"stderr",data:o})}),P.on("close",n=>{const o={exitCode:n,stdoutLength:h.length,stderrLength:f.length,stdout:h,stderr:f};console.log("-".repeat(80)),console.log("Process exited with code:",n),console.log("STDOUT length:",h.length),console.log("STDERR length:",f.length),h&&console.log("Full STDOUT:",h),f&&console.error("Full STDERR:",f),console.log("=".repeat(80)),console.log("LICENSE COMMAND EXECUTION END"),console.log("=".repeat(80)),a&&a.webContents.send("license-debug",{type:"summary",data:o});let t=null;if(h.trim())try{t=JSON.parse(h),console.log("✓ Successfully parsed JSON result:",t)}catch(d){console.warn("Could not parse stdout as JSON:",d)}if(n===0)if(t)l(t);else{const d="FRONTEND_JSON_PARSE_FAILED";console.error(`[${d}] No valid JSON output`),console.error("Raw stdout:",h),c({error:"Failed to parse license command output",stdout:h,stderr:f,error_code:d})}else{const d="FRONTEND_LICENSE_ACTIVATION_FAILED";console.error(`[${d}] Command failed with non-zero exit code ${n}`);let v=`License command failed with code ${n}`;(t!=null&&t.error||(t==null?void 0:t.success)===!1&&(t!=null&&t.error))&&(v=t.error),c({error:v,exitCode:n,stderr:f,stdout:h,parsedResult:t,error_code:d})}}),P.on("error",n=>{const o="FRONTEND_PYTHON_PROCESS_FAILED";console.error(`[${o}] Process error event:`,n),c({error:`Failed to run license command: ${n.message}`,errorName:n.name,errorStack:n.stack,error_code:o})})})}s.ipcMain.handle("license:get-status",async()=>{try{return await O("get-status")}catch(r){return console.error("Error getting license status:",r),{license_type:"trial",error:r.error||"Unknown error"}}});s.ipcMain.handle("license:activate",async(r,e)=>{console.log("=".repeat(80)),console.log("LICENSE ACTIVATION REQUESTED"),console.log("=".repeat(80)),console.log("License key length:",(e==null?void 0:e.length)||0),console.log("License key preview:",(e==null?void 0:e.substring(0,50))||"none"),a&&a.webContents.send("license-debug",{type:"info",data:{message:"Starting license activation...",licenseKeyLength:(e==null?void 0:e.length)||0}});try{return await O("activate",[e])}catch(l){console.error("Error activating license:",l);let c=l.error||"License activation failed";if(l.stdout)try{const p=JSON.parse(l.stdout);(p.error||p.success===!1&&p.error)&&(c=p.error)}catch{}if(l.stderr){const p=l.stderr.split(`
`);for(const E of p)if(E.includes("ERROR:")||E.includes("✗")){const u=E.match(/✗\s+(?:Activation failed|Error):\s*(.+)/i);if(u){c=u[1].trim();break}const y=E.match(/ERROR:\s*(.+)/i);if(y){c=y[1].trim();break}}}throw new Error(c)}});s.ipcMain.handle("license:deactivate",async()=>{try{return await O("deactivate")}catch(r){throw console.error("Error deactivating license:",r),new Error(r.error||"License deactivation failed")}});s.ipcMain.handle("license:get-trial-status",async()=>{try{return await O("get-trial-status")}catch(r){return console.error("Error getting trial status:",r),{status:"error",error:r.error||"Unknown error"}}});async function C(r,e=[]){return new Promise((l,c)=>{const p=i.resolve(s.app.getAppPath(),"../src/transmutation_codex/adapters/bridges/telemetry_bridge.py"),E=i.resolve(s.app.getAppPath(),"../.venv/Scripts/python.exe"),u=i.resolve(s.app.getAppPath(),"../.venv/bin/python");let y="python";try{const g=process.platform==="win32"?E:u;_.accessSync(g),y=g}catch{console.log("Using system Python for telemetry command")}const N=[p,r,...e.map(g=>JSON.stringify(g))];console.log("Running telemetry command:",r);const P=b.spawn(y,N);let h="",f="";P.stdout.on("data",g=>{h+=g.toString()}),P.stderr.on("data",g=>{f+=g.toString()}),P.on("close",g=>{if(g===0)try{const m=JSON.parse(h);l(m)}catch{l({success:!0})}else c({error:`Telemetry command failed with code ${g}`,stderr:f})}),P.on("error",g=>{c({error:`Failed to run telemetry command: ${g.message}`})})})}s.ipcMain.handle("telemetry:get-consent-status",async()=>{try{return await C("get-consent-status")}catch(r){return console.error("Error getting telemetry consent status:",r),{has_consent:!1,can_request:!0,error:r.error||"Unknown error"}}});s.ipcMain.handle("telemetry:grant-consent",async()=>{try{return await C("grant-consent")}catch(r){throw console.error("Error granting telemetry consent:",r),new Error(r.error||"Failed to grant consent")}});s.ipcMain.handle("telemetry:revoke-consent",async()=>{try{return await C("revoke-consent")}catch(r){throw console.error("Error revoking telemetry consent:",r),new Error(r.error||"Failed to revoke consent")}});s.ipcMain.handle("open-external",async(r,e)=>{const{shell:l}=require("electron");try{return await l.openExternal(e),{success:!0}}catch(c){return console.error("Error opening external URL:",c),{success:!1,error:c.message}}});
