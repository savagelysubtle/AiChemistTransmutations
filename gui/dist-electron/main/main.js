"use strict";const E=require("child_process"),n=require("electron"),x=require("node:fs"),d=require("node:path");require("electron-squirrel-startup")&&n.app.quit();let a;function O(){a=new n.BrowserWindow({width:1024,height:768,webPreferences:{preload:d.join(__dirname,"../preload/preload.js"),nodeIntegration:!1,contextIsolation:!0}}),process.env.NODE_ENV==="development"?(a.loadURL("http://localhost:3000"),a.webContents.openDevTools()):a.loadFile(d.join(__dirname,"../../dist/index.html")),a.on("closed",()=>{a=null})}n.app.whenReady().then(()=>{O(),n.app.on("activate",()=>{n.BrowserWindow.getAllWindows().length===0&&O()})});n.app.on("window-all-closed",()=>{process.platform!=="darwin"&&n.app.quit()});n.ipcMain.handle("dialog:openFile",async(e,o)=>{if(!a)return[];const c={properties:["openFile","multiSelections"]};o&&o.filters&&(c.filters=o.filters);const{canceled:l,filePaths:m}=await n.dialog.showOpenDialog(a,c);return l?[]:m});n.ipcMain.handle("dialog:openDirectory",async()=>{if(!a)return null;const{canceled:e,filePaths:o}=await n.dialog.showOpenDialog(a,{properties:["openDirectory"]});return e?null:o[0]});n.ipcMain.handle("run-conversion",async(e,{conversionType:o,inputFiles:c,outputDir:l,options:m})=>new Promise((f,y)=>{const w=d.resolve(n.app.getAppPath(),"../src/transmutation_codex/adapters/bridges/electron_bridge.py"),P=d.resolve(n.app.getAppPath(),"../.venv/Scripts/python.exe"),g=d.resolve(n.app.getAppPath(),"../.venv/bin/python");let h="python";try{const r=process.platform==="win32"?P:g;x.accessSync(r),h=r,console.log("Using venv Python:",h)}catch{console.log("Venv Python not found or accessible, using system Python.")}let u=[w,o,"--input-files",...c];l&&u.push("--output-dir",l),m&&Object.entries(m).forEach(([r,i])=>{if(i!=null&&typeof i!="object"){const s=`--${r.replace(/[A-Z]/g,b=>`-${b.toLowerCase()}`)}`;typeof i=="boolean"?i===!0&&u.push(s):u.push(s,String(i))}}),console.log("Spawning Python script:",h,"with args:",u.join(" "));const t=E.spawn(h,u);let p="";t.stdout.on("data",r=>{p+=r.toString(),console.log(`Python stdout chunk: ${r.toString()}`);let i=p.indexOf(`
`);for(;i!==-1;){const s=p.substring(0,i).trim();if(p=p.substring(i+1),s&&a)if(s.startsWith("PROGRESS:")||s.startsWith("BATCH_PROGRESS:")||s.startsWith("RESULT:")||s.startsWith("ERROR:")||s.startsWith("SINGLE_RESULT:")||s.startsWith("BATCH_RESULT:"))try{const b=s.substring(s.indexOf(":")+1),M=JSON.parse(b);a.webContents.send("conversion-event",M)}catch(b){console.error("Failed to parse JSON from Python:",s,b),a.webContents.send("conversion-event",{type:"raw_error",data:s,error:b.message})}else console.log("Non-JSON Python stdout:",s);i=p.indexOf(`
`)}});let v="";t.stderr.on("data",r=>{v+=r.toString(),console.error(`Python stderr chunk: ${r.toString()}`);let i=v.indexOf(`
`);for(;i!==-1;){const s=v.substring(0,i).trim();v=v.substring(i+1),s&&a&&a.webContents.send("conversion-event",{type:"stderr",data:s}),i=v.indexOf(`
`)}}),t.on("close",r=>{console.log(`Python script exited with code ${r}`),v.trim()&&a&&a.webContents.send("conversion-event",{type:"stderr",data:v.trim()}),r===0?f({success:!0,message:"Python script finished successfully."}):y({success:!1,message:`Python script exited with code ${r}. Check logs for details.`})}),t.on("error",r=>{console.error("Failed to start Python process:",r),y({success:!1,message:`Failed to start Python process: ${r.message}`})})}));n.ipcMain.handle("convert-mdx-to-md",async(e,{inputFile:o,outputFile:c})=>(console.log(`MDX to MD conversion requested for: ${o}`),{success:!1,error:"MDX to MD conversion is not yet implemented. React cannot run in Electron main process. This converter needs to be reimplemented as a spawned process or moved to Python backend."}));n.ipcMain.on("log:gui-cleared",()=>{console.log("======== GUI Log Cleared by User ========")});async function S(e,o=[]){return new Promise((c,l)=>{var u;const m=!process.defaultApp&&!((u=process.env.NODE_ENV)!=null&&u.includes("dev")),f=n.app.getAppPath();let y,w;if(m)y=d.join(f,"..","python-backend","aichemist_transmutation_codex.exe"),w=["-m","transmutation_codex.adapters.bridges.license_bridge",e,...o],console.log("Production mode - using bundled Python backend:",y);else{const t=d.resolve(f,"../src/transmutation_codex/adapters/bridges/license_bridge.py"),p=d.resolve(f,"../.venv/Scripts/python.exe"),v=d.resolve(f,"../.venv/bin/python");y="python";try{const r=process.platform==="win32"?p:v;x.accessSync(r),y=r}catch{console.log("Using system Python for license command")}w=[t,e,...o],console.log("Development mode - using Python script")}console.log("Running license command:",e,o);const P=E.spawn(y,w);let g="",h="";P.stdout.on("data",t=>{g+=t.toString()}),P.stderr.on("data",t=>{h+=t.toString()}),P.on("close",t=>{if(t===0)try{const p=JSON.parse(g);c(p)}catch{l({error:"Failed to parse license command output",stdout:g,stderr:h})}else l({error:`License command failed with code ${t}`,stderr:h})}),P.on("error",t=>{l({error:`Failed to run license command: ${t.message}`})})})}n.ipcMain.handle("license:get-status",async()=>{try{return await S("get-status")}catch(e){return console.error("Error getting license status:",e),{license_type:"trial",error:e.error||"Unknown error"}}});n.ipcMain.handle("license:activate",async(e,o)=>{try{return await S("activate",[o])}catch(c){throw console.error("Error activating license:",c),new Error(c.error||"License activation failed")}});n.ipcMain.handle("license:deactivate",async()=>{try{return await S("deactivate")}catch(e){throw console.error("Error deactivating license:",e),new Error(e.error||"License deactivation failed")}});n.ipcMain.handle("license:get-trial-status",async()=>{try{return await S("get-trial-status")}catch(e){return console.error("Error getting trial status:",e),{status:"error",error:e.error||"Unknown error"}}});async function _(e,o=[]){return new Promise((c,l)=>{const m=d.resolve(n.app.getAppPath(),"../src/transmutation_codex/adapters/bridges/telemetry_bridge.py"),f=d.resolve(n.app.getAppPath(),"../.venv/Scripts/python.exe"),y=d.resolve(n.app.getAppPath(),"../.venv/bin/python");let w="python";try{const t=process.platform==="win32"?f:y;x.accessSync(t),w=t}catch{console.log("Using system Python for telemetry command")}const P=[m,e,...o.map(t=>JSON.stringify(t))];console.log("Running telemetry command:",e);const g=E.spawn(w,P);let h="",u="";g.stdout.on("data",t=>{h+=t.toString()}),g.stderr.on("data",t=>{u+=t.toString()}),g.on("close",t=>{if(t===0)try{const p=JSON.parse(h);c(p)}catch{c({success:!0})}else l({error:`Telemetry command failed with code ${t}`,stderr:u})}),g.on("error",t=>{l({error:`Failed to run telemetry command: ${t.message}`})})})}n.ipcMain.handle("telemetry:get-consent-status",async()=>{try{return await _("get-consent-status")}catch(e){return console.error("Error getting telemetry consent status:",e),{has_consent:!1,can_request:!0,error:e.error||"Unknown error"}}});n.ipcMain.handle("telemetry:grant-consent",async()=>{try{return await _("grant-consent")}catch(e){throw console.error("Error granting telemetry consent:",e),new Error(e.error||"Failed to grant consent")}});n.ipcMain.handle("telemetry:revoke-consent",async()=>{try{return await _("revoke-consent")}catch(e){throw console.error("Error revoking telemetry consent:",e),new Error(e.error||"Failed to revoke consent")}});n.ipcMain.handle("open-external",async(e,o)=>{const{shell:c}=require("electron");try{return await c.openExternal(o),{success:!0}}catch(l){return console.error("Error opening external URL:",l),{success:!1,error:l.message}}});
